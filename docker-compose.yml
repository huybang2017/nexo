services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: nexo-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-nexo}
      POSTGRES_USER: ${POSTGRES_USER:-nexo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-nexo123}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nexo"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nexo-network

  # AI Service (FastAPI)
  ai-service:
    build:
      context: ./ai-service
      dockerfile: Dockerfile
    container_name: nexo-ai-service
    ports:
      - "${AI_SERVICE_PORT:-8001}:8001"
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./ai-service:/app
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - nexo-network
    depends_on:
      postgres:
        condition: service_healthy

  # Spring Boot Server
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: nexo-server
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      # Database
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:postgresql://postgres:5432/nexo}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-nexo}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-nexo123}
      
      # JWT
      - JWT_SECRET=${JWT_SECRET:-404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970}
      - JWT_ACCESS_EXPIRATION=${JWT_ACCESS_EXPIRATION:-3600000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-604800000}
      
      # CORS & App Config
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      - APP_OAUTH2_REDIRECT_URI=${APP_OAUTH2_REDIRECT_URI:-http://localhost:3000/oauth2/redirect}
      - FILE_UPLOAD_DIR=${FILE_UPLOAD_DIR:-./uploads}
      - FILE_MAX_SIZE=${FILE_MAX_SIZE:-52428800}
      
      # AI Service
      - AI_SERVICE_URL=${AI_SERVICE_URL:-http://ai-service:8001}
      - AI_SERVICE_ENABLED=${AI_SERVICE_ENABLED:-true}
      - AI_SERVICE_TIMEOUT=${AI_SERVICE_TIMEOUT:-60000}
      
      # OAuth2 Google
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-946215954235-cspmnap1n9fdqj9071okbo72ekb9uhro.apps.googleusercontent.com}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-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}
      
      # Email/SMTP
      - MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME:-ndhbang2017@gmail.com}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-vnwqubutzkfyanoe}
      
      # VNPay
      - VNPAY_TMN_CODE=${VNPAY_TMN_CODE:-DEMO}
      - VNPAY_HASH_SECRET=${VNPAY_HASH_SECRET:-DEMOSECRET}
      - VNPAY_URL=${VNPAY_URL:-https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}
      - VNPAY_RETURN_URL=${VNPAY_RETURN_URL:-http://localhost:3000/wallet/deposit/callback}
      - VNPAY_API_URL=${VNPAY_API_URL:-https://sandbox.vnpayment.vn/merchant_webapi/api/transaction}
      
      # MoMo
      - MOMO_MOCK_MODE=${MOMO_MOCK_MODE:-true}
      - MOMO_PARTNER_CODE=${MOMO_PARTNER_CODE:-MOMOXXXX}
      - MOMO_ACCESS_KEY=${MOMO_ACCESS_KEY:-your-access-key}
      - MOMO_SECRET_KEY=${MOMO_SECRET_KEY:-your-secret-key}
      - MOMO_API_URL=${MOMO_API_URL:-https://test-payment.momo.vn/v2/gateway/api/create}
      - MOMO_RETURN_URL=${MOMO_RETURN_URL:-http://localhost:3000/wallet/deposit/callback}
      - MOMO_NOTIFY_URL=${MOMO_NOTIFY_URL:-http://localhost:8080/api/payment/webhook/momo}
      
      # Stripe
      - STRIPE_MOCK_MODE=${STRIPE_MOCK_MODE:-false}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-sk_test_51QRvhnDlHYftbVUUEaJ0Nti4ak7wia4OI1YgEInL4WZgWfoD2bnzxTi73I5MVn8B9UmtmwPuHqDcGzA9EWs5d6sf00C4dB3pft}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-pk_test_51QRvhnDlHYftbVUUt0NNzEptMW7ffuQaRVmojQASmLoFUbjLvtL19Vu3zpOXr2EiUiPx47DQaW0m5m6Ve8OTIRmQ00rwRcDJHE}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-whsec_sRC5aHYGlGdDawd0bgnNjGl3hBQKiN2U}
      - STRIPE_RETURN_URL=${STRIPE_RETURN_URL:-http://localhost:3000/wallet/deposit/result}
    volumes:
      - ./server/uploads:/app/uploads
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8080/api/auth/me || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - nexo-network
    depends_on:
      postgres:
        condition: service_healthy
      ai-service:
        condition: service_healthy

  # React Frontend (Nginx)
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:8080}
    container_name: nexo-app
    ports:
      - "${APP_PORT:-3000}:3000"
    volumes:
      - ./app:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nexo-network
    depends_on:
      server:
        condition: service_healthy

volumes:
  postgres_data:
    driver: local

networks:
  nexo-network:
    driver: bridge
